frish {

  Main = TopLevel+
  TopLevel =
    | Defvar -- defvar
    | Defsynonym -- defsynonym
    | Defsubr -- defsubr
    | Defobj -- defobj
    | Builtin -- builtin
    | comment line? -- comment
    | line -- line

   Defvar = "defvar" Lval "⇐" Exp line?
   Defsubr = "defsubr" ident StatementBlock line?
   Defobj = "defobj" ident ObjFormals? line? "{" line? InitStatement+ "}" line?

   StatementBlock = line? "{" line? Rec_Statement line? "}" line?

   Rec_Statement = line? R_Statement line?
   R_Statement =
     | comment Rec_Statement? -- comment
     | Builtin Rec_Statement? -- builtin
     | Deftemp -- deftemp
     | Deftemps  -- deftemps
     | Defsynonym -- defsynonym     
     | IfStatement  -- if
     | "pass" Rec_Statement? -- pass
     | "return" ReturnExp -- return
     | ForStatement -- for
     | WhileStatement  -- while
     | Synonym -- synonym
     | Assignment -- assignment
     | "@" Lval Rec_Statement? -- call
     | line Rec_Statement? -- line
   CommaIdent = Comma ident

   Builtin = BuiltinPhrase line?
   BuiltinPhrase =
     | "%popchar" -- popchar
     | "%pop" -- pop
     | "%push" "(" Exp ")" -- push
     | "%scanfor" "(" ident ")" -- scanfor
     | "%assoc" "(" ident "," string "," Subraddress ")" -- assoc
     | "%lookup" "(" ident "," Exp ")" -- lookup
     | "%printnl" -- printnl
     | "%print" "(" Exp ")" -- print
     | "%empty-input" -- emptyinput
     | "%empty-string?" "(" Exp ")" -- emptystring
     | "%quit" -- quit
     | "%stack" -- stack
     | "%freshdict" -- freshdict
     | "%exec" ident -- exec
     | "%digits?" "(" Exp ")" -- isdigits
     | "%toint" "(" Exp ")" -- toint
     | "%input" -- input
     
     | "%" #ident Args? -- unrecognized

   Args = "(" StuffInsideParentheses* ")"

   Deftemp = "deftemp" Lval "⇐" Exp Rec_Statement?
   Deftemps = "deftemps" LvalComma+ "⇐" Exp Rec_Statement?
   Defsynonym = "defsynonym" Defsyn
   Defsyn =
     | Lval errorMessage "≡" Exp Rec_Statement? -- illegal
     | ident "≡" Exp Rec_Statement? -- legal

   InitStatement = "•" ident "⇐" Exp (comment | line)*

   IfStatement = "if" Exp StatementBlock ElifStatement* ElseStatement? Rec_Statement?
   ElifStatement = "elif" Exp StatementBlock
   ElseStatement = "else" StatementBlock

   ForStatement = "for" ident "in" Exp StatementBlock Rec_Statement?
   WhileStatement = "while" Exp StatementBlock Rec_Statement?

   Synonym = Lval "≡" Exp Rec_Statement?

   Assignment = 
     | "[" LvalComma+ "]" "⇐" Exp Rec_Statement? -- multiple
     | Lval "⇐" Exp Rec_Statement? -- single

   LvalComma = Lval Comma?

    ReturnExp =
      | "[" ExpComma+ "]" Rec_Statement? -- multiple
      | Exp Rec_Statement? -- single

    ExpComma = Exp Comma?
    
    Exp =  BooleanAndOrIn

    BooleanAndOrIn =
      | BooleanAndOrIn andOrIn BooleanExp -- andOrIn
      | BooleanExp -- default
      
    BooleanExp =
      | BooleanExp boolNeq BooleanNot -- boolopneq
      | BooleanExp boolOp BooleanNot -- boolop
      | BooleanNot -- basic

    BooleanNot =
      | "not" BooleanExp -- not
      | AddExp -- basic

    AddExp =
      | AddExp "+" MulExp  -- plus
      | AddExp "-" MulExp  -- minus
      | MulExp -- basic

    MulExp =
      | MulExp "*" ExpExp  -- times
      | MulExp "/" ExpExp  -- divide
      | ExpExp -- basic

    ExpExp =
      | Primary "^" ExpExp  -- power
      | Primary -- basic

    Primary =
      | PrimaryIndexed Actuals -- call
      | PrimaryIndexed -- plain

    PrimaryIndexed =
      | PrimaryIndexed "/" ident -- lookupident
      | PrimaryIndexed "/" PrimaryIndexed -- lookup
      | PrimaryIndexed "." ident -- fieldident
      | PrimaryIndexed "." PrimaryIndexed -- field
      | PrimaryIndexed "[" Exp "]" -- index
      | PrimaryIndexed "[" digit+ ":" "]" -- nthslice
      | Atom -- atom

    Atom =
      | Builtin -- builtin
      | "[" "]" -- emptylistconst
      | "{" "}" -- emptydict
      | "(" Exp ")" -- paren
      | "[" line? PrimaryComma+ line? "]" -- listconst
      | "{" line? PairComma+ line? "}" -- dict
      | phi -- phi
      | "⊤" -- true
      | "⊥" -- false
      | Subraddress -- subraddress
      | "range" "(" Exp ")" -- range
      | ident Actuals -- callident
      | string -- string
      | number -- number
      | ident -- ident


    Subraddress =  "↪︎" ident

    PrimaryComma = Primary Comma? line?
    PairComma = Pair Comma?

    StuffInsideParentheses =
      | "(" StuffInsideParentheses* ")" -- rec
      | ~"(" ~")" any -- default
    
    Lval = Exp

    Formals (Formals) =
      | "(" ")" -- noformals
      | "(" FormalComma* ")" -- withformals
    ObjFormals = Formals

    Formal = 
       | ident -- plain
       
    FormalComma = Formal Comma?
    
    Actuals = 
      | "(" ")" -- noactuals
      | "(" ActualComma* ")" line? -- actuals

   Actual = Exp
   ActualComma = comment? Actual Comma? line?

    number =
      | digit* "." digit+  -- fract
      | digit+             -- whole

    Pair = string ":" Exp Comma?
  

  andOrIn =
    | "and" -- and
    | "or" -- or
    | "in" -- in

  boolOp = (boolEq | boolNeq | "<=" | ">=" | ">" | "<")
  boolEq = "="
  boolNeq = "!="

  string = unicodestring | asciistring
  asciistring = "\"" astringchar* "\""
  astringchar = ~"\"" any
  unicodestring = "“" stringchar* "”"
  stringchar = 
    | "“" stringchar* "”" -- rec
    | ~"“" ~"”" any -- other

    keyword = (
        "defsynonym"
      | "deftemp"
      | "defobj"
      | "defvar"
      | "defsubr"
      | "pass"
      | "return"
      | "if"
      | "elif"
      | "else"
      | "and"
      | "or"
      | "in"
      | "not"
      | "range"
      | "while"
      | "as"
      | "pair"
      | phi
      )
      
  phi = ("ϕ" | "%CF%95")

  ident  = ~keyword idchar+
  idchar =
    | "❲" idchar+ "❳" -- rec
    | ~"❲" ~"❳" idch -- other

  idch = letter | digit | "_" | "-"

  comment = "⌈" commentchar* "⌉"
  commentchar = 
    | "⌈" commentchar* "⌉" -- rec
    | ~"⌈" ~"⌉" any -- other

  errorMessage = "⎝" errorchar* "⎠"
  errorchar =  
    | "⎝" errorchar* "⎠" -- rec
    | ~"⎝" ~"⎠" any -- other

  line = "⎩" (~"⎩" ~"⎭" any)* "⎭"

  Comma = line? "," line?
}
